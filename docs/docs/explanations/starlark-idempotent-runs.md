---
title: Starlark idempotent runs
sidebar_label: Starlark idempotent runs
---

Background
----------

Did you notice those lines in the `kurtosis run` command output?
```console
SKIPPED - This instruction has already been run in this enclave
```
To reduce execution time, Kurtosis tries to optimize each run of a Starlark package based on what has already been run 
in the enclave. 

For example if you try to run twice the exact same package, Kurtosis will skip all the instructions for the second run
because they were already executed in the first run. 

:::info
This feature is still experimental and can be deactivated by adding `--experimental NO_INSTRUCTIONS_CACHING` parameter 
to the `kurtosis run` command.
:::

How it works
------------

#### Definitions

We call the _enclave plan_ the sequence of Starlark instructions that were executed inside this enclave.

When a new package is run, we call the _submitted plan_ the set of instructions generated by interpreting the package but not yet executed.

Inside a plan (enclave plan or submitted plan), it is said that an instruction (i.e. `instruction_1`) _depends_ on 
another instruction (`instruction_2`) iff `instruction_2` is located _before_ `instruction_1` in the plan's instructions
sequence.

Two instructions are said to be _equivalent_ iff their Starlark representations are strictly equal.

#### Criteria to skip an instruction
The way Kurtosis optimize the submitted plan before executing it is by following this heuristic:

1. any instruction from the _submitted plan_ that is executed inside the enclave is appended to the _enclave plan_
1. for any given instruction from the _submitted plan_, it is effectively skipped (i.e. not executed) if:
   1. it exists one instruction in the *enclave plan* equivalent to this instruction (called the _matched instruction_ below)
   1. and ONE of the following assertions is true:
      1. there is no direct dependent instruction for this instruction in the _submitted plan_. Put it simply, it is the last instruction of the _submitted plan_
      1. there is no direct dependent instruction for the _matched instruction_ in the _enclave plan_. Put it simply, the _matched instruction_ is the last instruction of the _enclave plan_
      1. the sequence of direct dependent instructions for the _matched instruction_ in the _enclave plan_ is a _prefix_ of the sequence of direct dependent instructions of the _instruction_ from the _submitted plan_

Examples
--------

#### Case of a _submitted plan_ being disjoint from the _enclave plan_
No instruction get skipped, all instructions from the _submitted plan_ are appended to the _enclave plan_.

![disjoint-plans.png](/img/explanations/starlark-idempotent-run/disjoint-plans.png)

#### Case of a _submitted plan_ being a sub-sequence of the _enclave plan_
All instructions from the _submitted plan_ are skipped because they were all present in the _enclave plan_ (therefore 
already executed inside this enclave).

![sub-sequence-plan.png](/img/explanations/starlark-idempotent-run/sub-sequence-plan.png)

#### Case of a _submitted plan_ partially overlapping the _enclave plan_
The overlapping instructions from the _submitted plan_ are skipped but the new ones (i.e. non-overlapping ones) are
executed and appended to the _enclave plan_.

![overlapping-plan.png](/img/explanations/starlark-idempotent-run/overlapping-plan.png)

#### Case of a _submitted plan_ incompatible with the _enclave plan_
Even though there are overlapping instructions in the _submitted plan_, the sequence of instructions itself is 
incompatible with the _enclave plan_ because there exist at least one dependent instruction in the _enclave plan_ that 
is not in the _submitted plan_. Kurtosis cannot optimize the _submitted plan_, and therefore falls back to the naive
behaviour of considering the _submitted plan_ as a sequence of new instructions.

![incompatible-plans.png](/img/explanations/starlark-idempotent-run/incompatible-plans.png)

Note that in this case, it is possible (and even likely) the execution of the submitted plan will fail. For example, if 
instruction 1 is an `add_service` instruction, it will fail because the service being added already exist inside the 
enclave. 
