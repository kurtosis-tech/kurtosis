---
title: How do idempotent runs work?
sidebar_label: Idempotent Runs
---

Background
----------

:::tip
To learn about what idempotent runs are in Kurtosis and the motivation behind this feature, go [here][idempotent-run-concept-reference].
:::

When running the `kurtosis run` command, you may notice the following message get printed:
```console
SKIPPED - This instruction has already been run in this enclave
```
The reason this happens is because Kurtosis will optimize each run of a Starlark package based on what has already been run in a given enclave, thus reducing execution time and resources.

This means when you try to run the exact same package twice in a row, Kurtosis will skip all the instructions for the second run because they were already executed in the first run.

:::info
This feature is still experimental and can be deactivated by adding `--experimental NO_INSTRUCTIONS_CACHING` parameter to the `kurtosis run` command.
:::

How it works
------------

#### Definitions

The __enclave plan__ is defined as the sequence of Starlark instructions that were previously executed inside a given enclave. Meanwhile, the __submitted plan__ is defined as the set of instructions generated by interpreting the package before it gets executed.

Within a plan, whether it be an _enclave_ or _submitted_ plan, Kurtosis considers a given instruction `instruction_2` to be dependent on another instruction `instruction_1` if and only if `instruction_2` is sequenced to take place _after_ `instruction_1` in the plan's instruction sequence.



Two instructions are said to be _equivalent_ if and only if their Starlark representations are strictly equal.

#### Criteria to skip an instruction
Kurtosis uses the following heuristic to determine which parts of a plan to skip in order to optimize runs:

1. Any instruction from the _submitted plan_ that is executed inside the enclave is appended to the _enclave plan_
1. For any given instruction from the _submitted plan_, it is effectively skipped (i.e. not executed) if:
   1. There exists one instruction in the *enclave plan* that is equivalent to this instruction in the _enclave plan_(called the _matched instruction_ below)
   1. And if at least ONE of the following assertions is true:
      1. There is no direct dependent instruction for the given instruction in the _submitted plan_. Put it simply, it is the last instruction of the _submitted plan_.
      1. There is no direct dependent instruction for the _matched instruction_ in the _enclave plan_. Put it simply, the _matched instruction_ is the last instruction of the _enclave plan_.
      1. The sequence of direct dependent instructions for the _matched instruction_ in the _enclave plan_ is a _prefix_ of the sequence of direct dependent instructions of the _instruction_ from the _submitted plan_.

Examples
--------

#### Case of a _submitted plan_ being disjoint from the _enclave plan_
No instruction get skipped, all instructions from the _submitted plan_ are appended to the _enclave plan_.

![disjoint-plans.png](/img/explanations/starlark-idempotent-run/disjoint-plans.png)

#### Case of a _submitted plan_ being a sub-sequence of the _enclave plan_
All instructions from the _submitted plan_ are skipped because they were all present in the _enclave plan_ (therefore 
already executed inside this enclave).

![sub-sequence-plan.png](/img/explanations/starlark-idempotent-run/sub-sequence-plan.png)

#### Case of a _submitted plan_ partially overlapping the _enclave plan_
The overlapping instructions from the _submitted plan_ are skipped but the new ones (i.e. non-overlapping ones) are
executed and appended to the _enclave plan_.

![overlapping-plan.png](/img/explanations/starlark-idempotent-run/overlapping-plan.png)

#### Case of a _submitted plan_ incompatible with the _enclave plan_
Even though there are overlapping instructions in the _submitted plan_, the sequence of instructions itself is 
incompatible with the _enclave plan_ because there exist at least one dependent instruction in the _enclave plan_ that 
is not in the _submitted plan_. Kurtosis cannot optimize the _submitted plan_, and therefore falls back to the naive
behaviour of considering the _submitted plan_ as a sequence of new instructions.

![incompatible-plans.png](/img/explanations/starlark-idempotent-run/incompatible-plans.png)

Note that in this case, it is possible (and even likely) the execution of the submitted plan will fail. For example, if 
instruction 1 is an `add_service` instruction, it will fail because the service being added already exist inside the 
enclave. 



<!---------------------------------- REFERENCE LINKS ---------------------------------------------------------->
[idempotent-run-concept-reference]: ../concepts-reference/idempotent-runs.md
